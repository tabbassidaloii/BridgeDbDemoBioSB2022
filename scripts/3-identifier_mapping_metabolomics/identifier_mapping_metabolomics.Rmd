---
title: "identifier_mapping_metabolomics"
author: 
- "DeniseSl22"
- "ddedesener"
date: "20/06/22"
output:
 md_document:
    variant: markdown_github
always_allow_html: true
---
## Introduction
In this section, identifier (IDs) mapping is performed on an example metabolomics data set, which was original annotated using HMDB symbols.
The dataset has been preprocessed already, for details see step 7 and 8 of the multi-omics workflow at: https://github.com/BiGCAT-UM/Transcriptomics_Metabolomics_Analysis/tree/master/metabolomics_analysis .
We map the HGNCMDB symbols to ChEBI IDs, since tools downstream of this step require different input formats for the IDs.

We use one tool for this mapping: BridgeDb [doi:10.18129/B9.bioc.BridgeDbR].

## Setup
```{r setup, warning=FALSE, message=FALSE}
# check if libraries are already installed > otherwise install it
#if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
if(!"rstudioapi" %in% installed.packages()) BiocManager::install("rstudioapi")
if(!"dplyr" %in% installed.packages()) BiocManager::install("dplyr")
if(!"BridgeDbR" %in% installed.packages()) BiocManager::install("BridgeDbR")
if(!"rJava" %in% installed.packages()) install.packages("rJava")
 ## See https://www.r-bloggers.com/2018/02/installing-rjava-on-ubuntu/ if you have issues with this package on Ubuntu.

#load libraries
library(rstudioapi)
library(dplyr)
library(BridgeDbR)
library(rJava)

# set your working environment to the location where your current source file is saved into.
setwd(dirname(rstudioapi::getSourceEditorContext()$path))
```

## Map metabolite data
```{r metabolite_data, warning=FALSE, message=FALSE}
#read data
mbxData_CD <- read.csv("data/mbxData_CD.csv")
mbxData_UC <- read.csv("data/mbxData_UC.csv")
#filter out unused columns
mbxData_CD <- mbxData_CD [,c(1,3,4)]
mbxData_UC <- mbxData_UC [,c(1,3,4)]

#Transform HMDB IDs to ChEBI IDs:

##Set the working directory to download the Metabolite mapping file
location <- "data/metabolites.bridge"
checkfile <- paste0(getwd(), '/' ,location)

##Download the Metabolite mapping file (if it doesn't exist locally yet):
if (!file.exists(checkfile)) {
download.file(
  "https://figshare.com/ndownloader/files/26001794",
  location)
}
#Load the ID mapper:
mapper <-  BridgeDbR ::loadDatabase(checkfile)

## Obtain the System codes for the databases HMDB (source database of dataset) and ChEBI (intended output database)
code <- getOrganismCode("Homo sapiens")
code_mappingFrom <- getSystemCode("HMDB")
code_mappingTo   <- getSystemCode("ChEBI")

##CD
## Create a data frame with the mappings and the correct SystemCode
input = data.frame(
    source = rep(code_mappingFrom, length(mbxData_CD$X)),
    identifier = mbxData_CD$X)
#Obtain all mappings from HMDB to ChEBI
MultiMappings = BridgeDbR::maps(mapper, input, code_mappingTo)
#remove all rows in the mapped data which do not include the prefix "CHEBI"
MultiMappings <- MultiMappings %>% filter(grepl("CHEBI",mapping, fixed = TRUE))
#filter out double identifiers because there are one-to-many relationship between hmdb and chebi IDs
MultiMappings <- MultiMappings %>% distinct (MultiMappings$identifier, .keep_all = TRUE)
MultiMappings <- MultiMappings [,c(2,4)]

merged.data_CD<- merge(MultiMappings, mbxData_CD,by.x="identifier", by.y="X",sort = TRUE, all.x = TRUE, all.y = TRUE)
#filter out metabolites that has NA value for CHEBI
merged.data_CD<- merged.data_CD %>% tidyr::drop_na(mapping)
#change column names
colnames(merged.data_CD) <- c("HMDBID","CHEBI", "log2FC_met", "pvalue_met")
#add type column 
merged.data_CD ["data.type"] <- "metabolomics" 
merged.data_CD <- merged.data_CD [,-1]
colnames(merged.data_CD) <- c("Identifier","log2FC","pvalue","data.type")

##UC
## Create a data frame with the mappings and the correct SystemCode
input = data.frame(
    source = rep(code_mappingFrom, length(mbxData_UC$X)),
    identifier = mbxData_UC$X)
#Obtain all mappings from HMDB to ChEBI
MultiMappings = BridgeDbR::maps(mapper, input, code_mappingTo)
#remove all rows in the mapped data which do not include the prefix "CHEBI"
MultiMappings <- MultiMappings %>% filter(grepl("CHEBI",mapping, fixed = TRUE))
#filter out double identifiers because there are one-to-many relationship between hmdb and chebi IDs
MultiMappings <- MultiMappings %>% distinct (MultiMappings$identifier, .keep_all = TRUE)
MultiMappings <- MultiMappings [,c(2,4)]

merged.data_UC<- merge(MultiMappings, mbxData_UC,by.x="identifier", by.y="X",sort = TRUE, all.x = TRUE, all.y = TRUE)
#filter out metabolites that has NA value for CHEBI
merged.data_UC<- merged.data_UC %>% tidyr::drop_na(mapping)
#change column names
colnames(merged.data_UC) <- c("HMDBID","CHEBI", "log2FC_met", "pvalue_met")
#add type column 
merged.data_UC ["data.type"] <- "metabolomics" 
merged.data_UC <- merged.data_UC [,-1]
colnames(merged.data_UC) <- c("Identifier","log2FC","pvalue","data.type")
```


